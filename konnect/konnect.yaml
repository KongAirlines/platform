# TLDR for the the file layout below 
# --- 
# platform:
#   The configuration for the platform repository
# teams:
#   The engineering organization's teams, their git repos and associated services
# organizations:
#   The organization's Konnect configuration. Defines environments (DEV/PRD)
#   and what teams and services belong in them.

---
# The platform key defines the platform team configuration
platform:
  # This is the repo where platform team automations, configuration, and other 
  # artifacts are pushed.
  git:
    remote: https://github.com/KongAirlines/platform.git 
    author:
      name: "Konnect Orchestrator"
      email: "ko@konghq.com"
    github:
      token: &platform_github_token
        type: file
        value: $HOME/.github/20241213-KongAirlines-platform.pat
    auth: # Used for git authorization
      # type is required and can be either: `ssh` or `token`
      type: token
      token: *platform_github_token
      #ssh:
      #  key:
      #    type: file
      #    value: $HOME/.ssh/id_ed25519


# teams define the names, description, and members of engineering groups.
#   teams are associated with services. These are the applications they build
#   and maintain. 
teams:
  customer-data:
    # The Konnect orchestrator creates a Konnect team for each team defined here. 
    description: Kong Air Customer Data team
    # Assuming we have IdP configurations configured and enabled, we can assign
    # the team managed here to a list of IdP manged group claims.
    idp-group-mappings:
      - "customer-data"
      - "api-producer"
    users:
      - "rick.spurgeon+KAFD1@konghq.com"
    services:
      KongAirlines/customer:
        name: customers
        description: Provides the KongAir customer information including customer name, address, and other details.
        git:
          remote: git@github.com:KongAirlines/customer.git 
          auth:
            type: ssh
            ssh:
              key:
                type: file
                value: $HOME/.ssh/id_ed25519
        spec-path: openapi.yaml
      KongAirlines/bookings:
        name: bookings
        description: Provides the KongAir booking information including booking number, flight number, and other details.
        git:
          remote: git@github.com:KongAirlines/bookings.git
          auth:
            type: ssh
            ssh:
              key:
                type: file
                value: $HOME/.ssh/id_ed25519
        spec-path: openapi.yaml

  flight-data:
    description: Kong Air Flight Data team
    # Users are invited to Konnect if they aren't already registered
    users:
      - "rick.spurgeon+KAFD1@konghq.com"
      - "rick.spurgeon+KAFD2@konghq.com"
    # services are the applications this team builds and maintains.
    #   Each service provides sufficient metadata to allow the orchestrator
    #   to apply service specific configurations and policies.
    services:
      KongAirlines/destinations:
        # The service key supports a heirarchical name.
        # This can support service specific patches by allowing patches to be 
        # specified in a matching folder structure.
        name: destinations
        description: Provides the KongAir destination information including flight origin and destination codes. The API also provdes average duration of flight time for each flight route.
        git:
          remote: git@github.com:KongAirlines/destinations.git 
          auth:
            type: ssh
            ssh:
              key:
                type: file
                value: $HOME/.ssh/id_ed25519
        # The idea with spec-path is a pointer to an OAS3 spec file, which is used
        # as a basis for Kong Gateway configuration generation by the central automation
        spec-path: openapi.yaml # relative to the vcs root 
      KongAirlines/flights:
        name: flights
        description: Provides the KongAir flights information including flight number and other details.
        git:
          remote: git@github.com:KongAirlines/flights.git
          auth:
            type: ssh
            ssh:
              key:
                type: file
                value: $HOME/.ssh/id_ed25519
        spec-path: openapi.yaml

# The organizations field defines the topology of the managed teams and services across 
# one or more Konnect Organizations. This allows the orchestrator to
# manage consistent resource names and configurations
organizations:

  # This key is arbitrary, but it's recommended to relate to 
  # the organization name within Konnect
  KongAirlines:

    # This configures how the orchestrator authenticates to Konnect APIs.
    # API calls are scoped to organizations via the access-token used,
    # thus, we don't need to track the org ID here.
    # The access-token field supports a file, environment variable, or literal string type.
    access-token:
      type: file
      value: $HOME/.konnect/20241211-ka-ko.spat
      # ---
      # type: env
      # value: KONNECT_ACCESS_TOKEN
      # ---
      # type: literal # not recommended to prevent accidental exposure
      # value: pat_ajbjdkfjhfhijajaj
 
    # This defines the organization's Konnect _user_ authentication configuration,
    # including IdP configurations and team mappings.
    # It is recommended to use a single authentication method, however, 
    # Konnect supports the ability to combine built-in authentication with either OIDC or SAML based SSO. 
    # Combining both OIDC and SAML based SSO is not supported. Keep built-in authentication enabled 
    # while you are testing IdP authentication and only disable it after successfully testing your SSO configuration.
    authorization:
      built-in:
        enabled: true
      oidc:
        enabled: true
        login-path: kongairlines
        issuer: https://dev-26696402.okta.com/oauth2/default
        client-id: 0oamj7tntcMapIsET5d7
        client-secret:
          type: file
          value: $HOME/.konnect/kongairlines-oidc-client-secret.txt
        claim-mappings:
          email: email
          name: name
          groups: groups
        scopes:
          - openid
          - email
          - profile
      saml:
        enabled: false
        login-path: kongairlines_saml
        idp-metadata-url: https://dev-26696402.okta.com/app/exkmoj7cryENs4tDa5d7/sso/saml/metadata
      team-mappings:
        built-in:
          enabled: true
        idp:
          enabled: true
          mappings:
            "Organization Admin": 
            - "platform"
            - "api-admins"
      
    environments:
      dev: # an environment name
        # `type` is required and can be either: `DEV` or `PROD`
        #   These values are well known to the orchestrator and are used to determine the 
        #   policies applied to resources
        type: DEV
        # `region` is required and must equal one of the Konnect supported region strings
        region: us
        # Here we are defining which team's services are deployed to this environment
        teams:
          flight-data:
            services:
              KongAirlines/destination:
                # The branch tells the orchestrator where to find environment specific resources
                branch: dev
              KongAirlines/flights:
                branch: dev
          customer-data:
            services:
              KongAirlines/customer:
                branch: dev
              KongAirlines/bookings:
                branch: dev
      prd:
        type: PROD
        region: us
        teams:
          flight-data:
            services:
              KongAirlines/destinations:
                branch: main
              KongAirlines/flights:
                branch: main
          customer-data:
            services:
              KongAirlines/customer:
                branch: main
              KongAirlines/bookings:
                branch: main
